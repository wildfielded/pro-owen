# Вариант решения на стеке Ubuntu Server + Apache + Python #

Файл **`main.py`** выполняется на сервере, генерит HTML, который отдаётся
HTTP-сервером браузеру на рабочей станции дежурного персонала.

### Динамическое (постепенно меняющееся) ТЗ ###

1. Забрать по SMB/CIFS текстовый файл **`lastdata.txt`** в кодировке **UTF-8**
(но иногда при отладке нового функционала программы файлы идут в старой
**Windows-1251**), в котором построчно (для каждого датчика) 4 поля, разделённых
табами: `EventDate` (дата), `EventTime` (время), `Description` (место датчика),
`Value` (температура).
2. Забрать по SMB/CIFS текстовый файл **`lastcfg.txt`** в кодировке
**Windows-1251**, (сейчас уже изменили на **UTF-8**) в котором построчно (для
каждого датчика) 3 поля, разделённые табами: `Description` (место датчика),
`Max1` (&laquo;жёлтый&raquo; порог температуры), Max2 (&laquo;красный&raquo;
порог температуры).
3. Поступившие данные надо распарсить, выдать текущую температуру на web-page и
сохранить в истории.
4. В истории хранить данные за определённый интервал времени (типовое
значение&nbsp;&mdash; 1 час). Устаревшие данные удалять. На основании этих
данных генерить графики в PNG-файлах по каждому датчику.
5. Если показания датчика достигают пороговых значений, на web-page и в графиках
истории должны происходить соответствующие раскраски. Появляются дополнительные
строки таблицы или поля ниже таблицы (как вариант&nbsp;&mdash; может вылетать
модальное окно) с кнопками квитирования, плюс проигрываться страшные звуки
тревоги (которые прекращаются по нажатию кнопки).
6. Датчики иногда сбоят и если нет данных больше минуты, то вместо цифр в файл
выдаётся **`?`**. Также сама программа иногда вылетает и перестаёт обновлять
файл на шаре. По этим случаям также предусмотреть аудиовизуальные алерты.

----

### Done (что сделано) ###

- Все настроечные константы вынесены в отдельный импортируемый модуль
**`configowen.py`**. Понятно, что вместо файла с рабочими конфиденциальными
параметрами на репозитории размещается **`configowen_FAKE.py`**, который надо
переименовать обратно и выставить требуемые настройки.
- Забираем файлы измерений и порогов с сетевого ресурса к себе. При этом идёт
проверка наличия файлов и &laquo;свежесть&raquo; файла измерений (должен быть не
старее 2 минут). В случаях отсутствия или критичной &nbsp;протухлости&nbsp;
вместо таблицы выдаётся соответствующее сообщение.
- Обработка случаев &laquo;разнобоя&raquo; с кодировками файлов данных и
пороговых значений.
- Обработка случаев с знаком **`?`** и других непонятных ошибок чтения данных.
- Обработка превышений пороговых значений.
- Генерилка простенького HTML c автообновлением. Выдача в таблицу местоположения
датчиков и температуры. Раскраска ячеек с текущими показаниями по статусу:
**green / yellow / red / gray / black**.
- Обработка ошибок через **`try/except/else/finally`**.
- Минимальное логирование по сети через **`syslog`**. Поскольку проект работает
на версии **python-3.8.10**, там не так много возможностей настройки (как в
версии 3.10), но и этого вполне достаточно для отладки и мониторинга.
- Хранение истории измерений без привлечения каких-либо БД, обошлись форматом
**JSON**.
- История в графическом виде. Разные **NumPy, Matplotlib, etc.**&nbsp;&mdash;
это, конечно, замечательно, но пока обошлось установкой из хранилища **PyPI**
простецкого **`PyPNG`**. Реализована четырёхцветная палитра для расцвечивания
превышений порогов. Сами пороги появляются сверху при приближении к ним среднего
значения температуры.
- Звуковая сигнализация срабатывает при возникновении события перехода через
пороговое значения и при следующем измерении уже не кричит (только когда пройден
ещё какой-нибудь порог). Изначально сирена воет один раз и недолго. Но для
выбешивания дежурного персонала можно в файле **`script.js`** выставить
**`loopPlaying=true`** так, чтобы рёв был до тех пор, пока не нажата кнопка на
странице.
- Работает на сервере **Ubuntu** с HTTP-сервером **Apache**.

----

### Инструкция по развёртыванию проекта ###

[**`.ADDS`**](https://github.com/wildfielded/pet-owen/tree/master/PoC/.ADDS)&nbsp;&mdash;
дополнительные вещи и телодвижения для деплоя.

PoC-версия проекта размещается на Linux-серваке например в **`/opt/pet/owen`**,
а создаваемый HTML-файл будет скидываться в **`/var/www/html/owen/index.html`**,
где Apache web-server (заранее установленный и соответственно настроенный) будет
раздавать его всем желающим по URL `http://hostname/owen`.

Туда же надо закинуть из
[**PoC/WEB**](https://github.com/wildfielded/pet-owen/tree/master/PoC/WEB)
звуковой файл **`sirena.wav`**, а также **`style.css`**, **`script.js`**, в
которых при желании и терпении можно навести любую требуемую красоту.

На Ubuntu помимо установленного пакета **`apache2`** требуется установить
(через привычный **`apt install`** или вручную скачанные с
[PyPI](https://pypi.org)) пакеты **`PySMB`** и **`PyPNG`**. Или же вместо этого
можно установить (если нет) пакетный менеджер Python `sudo apt install pipenv`,
и затем уже дать команду:

    ```bash
    sudo pip3 install -r requirements_poc.txt
    ```

Запуск по крону.

----

### TODO (ближайшие планы) ###

- Нормальная генерилка HTML.
- Адаптация для требуемых версий дистрибутива **Astra Linux**.
- Улучшайзинг кода и фиченаворотинг. Попытаться сделать код более оптимальным и
читабельным по мере прокачки экспы.

----
